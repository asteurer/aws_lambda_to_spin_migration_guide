FROM asteurer/go_spin

COPY main.go main.go
COPY go.mod go.mod
COPY go.sum go.sum
COPY spin.toml spin.toml

RUN go mod download

ARG DOCKERHUB_USER
ARG DOCKERHUB_PASSWORD
ARG IMAGE_TAG
# ARG SPIN_VARIABLE_AWS_ACCESS_KEY_ID
# ARG SPIN_VARIABLE_AWS_SECRET_ACCESS_KEY
# ARG SPIN_VARIABLE_AWS_SESSION_TOKEN
# ARG SPIN_VARIABLE_AWS_DEFAULT_REGION
# ARG SPIN_VARIABLE_AWS_SERVICE
# ARG SPIN_VARIABLE_AWS_HOST

# ENV SPIN_VARIABLE_AWS_ACCESS_KEY_ID=${SPIN_VARIABLE_AWS_ACCESS_KEY_ID}
# ENV SPIN_VARIABLE_AWS_SECRET_ACCESS_KEY=${SPIN_VARIABLE_AWS_SECRET_ACCESS_KEY}
# ENV SPIN_VARIABLE_AWS_SESSION_TOKEN=${SPIN_VARIABLE_AWS_SESSION_TOKEN}
# ENV SPIN_VARIABLE_AWS_DEFAULT_REGION=${SPIN_VARIABLE_AWS_DEFAULT_REGION}
# ENV SPIN_VARIABLE_AWS_SERVICE=${SPIN_VARIABLE_AWS_SERVICE}
# ENV SPIN_VARIABLE_AWS_HOST=${SPIN_VARIABLE_AWS_HOST}

RUN spin build
RUN spin registry login index.docker.io -u ${DOCKERHUB_USER} -p ${DOCKERHUB_PASSWORD}
RUN spin registry push index.docker.io/${DOCKERHUB_USER}/${IMAGE_TAG}